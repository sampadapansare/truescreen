<script>
const socket = io();
const room = "{{ meeting_id }}";
const role = "candidate";  // âš ï¸ CHANGE THIS to "interviewer" or "candidate"
const localVideo = document.getElementById('localVideo');
const remoteContainer = document.getElementById('remoteContainer');
const alertBox = document.getElementById('alert-box');
const peers = {};
let localStream;
let micOn = true;
let camOn = true;

async function init() {
  socket.emit('join-room', { room, role });

  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = localStream;

  socket.on('user-joined', ({ sid }) => {
    const pc = createPeerConnection(sid);
    peers[sid] = pc;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.createOffer().then(offer => {
      pc.setLocalDescription(offer);
      socket.emit('signal', { type: 'offer', offer, to: sid, room });
    });
  });

  socket.on('signal', async ({ type, offer, answer, candidate, from }) => {
    let pc = peers[from];
    if (!pc) {
      pc = createPeerConnection(from);
      peers[from] = pc;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    if (type === 'offer') {
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      socket.emit('signal', { type: 'answer', answer: ans, to: from, room });
    } else if (type === 'answer') {
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
    } else if (type === 'candidate') {
      await pc.addIceCandidate(new RTCIceCandidate(candidate));
    }
  });

  socket.on('fraud-alert', ({ message }) => {
    if (message) {
      alertBox.textContent = message;
      alertBox.classList.add("alert-danger");
    } else {
      alertBox.textContent = '';
      alertBox.classList.remove("alert-danger");
    }
  });

  if (role === 'candidate') {
    setInterval(captureAndDetect, 2000);
  }
}

function createPeerConnection(id) {
  const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

  pc.onicecandidate = e => {
    if (e.candidate) {
      socket.emit('signal', { type: 'candidate', candidate: e.candidate, to: id, room });
    }
  };

  pc.ontrack = e => {
    const remoteVideo = document.getElementById(`remote-${id}`) || createRemoteVideo(id);
    remoteVideo.srcObject = e.streams[0];
  };

  return pc;
}

function createRemoteVideo(id) {
  const video = document.createElement('video');
  video.id = `remote-${id}`;
  video.autoplay = true;
  video.playsInline = true;
  video.style = 'width:45%; border:3px solid #2f3640; border-radius:8px; margin:10px;';
  remoteContainer.appendChild(video);
  return video;
}

async function captureAndDetect() {
  const video = document.getElementById('localVideo');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  canvas.toBlob(blob => {
    const form = new FormData();
    form.append('frame', blob, 'frame.jpg');
    form.append('room', room);
    fetch('/detect', { method: 'POST', body: form });
  }, 'image/jpeg', 0.7);
}

function toggleMic() {
  micOn = !micOn;
  localStream.getAudioTracks().forEach(track => track.enabled = micOn);
}

function toggleCamera() {
  camOn = !camOn;
  localStream.getVideoTracks().forEach(track => track.enabled = camOn);
}

window.onload = () => {
  init();
};
</script>
