<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Interview Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>

    <style>
        .control-buttons {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="brand">TrueScreen</div>
        <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    </div>

    <div class="container video-page text-center">
        <h2>Meeting ID: {{ meeting_id }}</h2>
        <div id="alert-box" class="alert"></div>

        <div class="control-buttons">
            <button class="btn btn-primary" onclick="toggleMic()">ðŸŽ¤ Mute/Unmute</button>
            <button class="btn btn-secondary" onclick="toggleCamera()">ðŸ“· Camera On/Off</button>
        </div>

        <div class="d-flex justify-content-center align-items-start flex-wrap">
            <video id="localVideo" autoplay muted playsinline
                style="width:45%;border:3px solid #2f3640;border-radius:8px;"></video>
            <div id="remoteContainer" style="display: flex; flex-wrap: wrap;"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const room = "{{ meeting_id }}";
        const username = "{{ username }}";
        const localVideo = document.getElementById('localVideo');
        const remoteContainer = document.getElementById('remoteContainer');
        const peers = {};
        let localStream;
        let micOn = true;
        let camOn = true;

        async function init() {
            socket.emit('join-room', { room, username });

            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;

            socket.on('user-joined', ({ sid }) => {
                const pc = createPeerConnection(sid);
                peers[sid] = pc;
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

                pc.createOffer().then(offer => {
                    pc.setLocalDescription(offer);
                    socket.emit('signal', { type: 'offer', offer, to: sid, room });
                });
            });

            socket.on('signal', async ({ type, offer, answer, candidate, from }) => {
                let pc = peers[from];
                if (!pc) {
                    pc = createPeerConnection(from);
                    peers[from] = pc;
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                }

                if (type === 'offer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(offer));
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    socket.emit('signal', { type: 'answer', answer: ans, to: from, room });
                } else if (type === 'answer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                } else if (type === 'candidate') {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                }
            });

            socket.on('fraud-alert', data => {
                document.getElementById('alert-box').innerText = data.message;
            });

            socket.on('tab_switch_warning', data => {
                const warning = document.createElement('div');
                warning.innerText = 'âš ï¸ Tab switch detected! Stay on the interview tab.';
                warning.style = 'background: red; color: white; position: fixed; top: 10px; left: 10px; padding: 10px; z-index: 9999;';
                document.body.appendChild(warning);
                setTimeout(() => warning.remove(), 3000);
            });
        }

        function createPeerConnection(id) {
            const pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            pc.onicecandidate = e => {
                if (e.candidate) {
                    socket.emit('signal', { type: 'candidate', candidate: e.candidate, to: id, room });
                }
            };

            pc.ontrack = e => {
                const remoteVideo = document.getElementById(`remote-${id}`) || createRemoteVideo(id);
                remoteVideo.srcObject = e.streams[0];
            };

            return pc;
        }

        function createRemoteVideo(id) {
            const video = document.createElement('video');
            video.id = `remote-${id}`;
            video.autoplay = true;
            video.playsInline = true;
            video.style = 'width:45%; border:3px solid #2f3640; border-radius:8px; margin:10px;';
            remoteContainer.appendChild(video);
            return video;
        }

        function toggleMic() {
            micOn = !micOn;
            localStream.getAudioTracks().forEach(track => track.enabled = micOn);
        }

        function toggleCamera() {
            camOn = !camOn;
            localStream.getVideoTracks().forEach(track => track.enabled = camOn);
        }

        // Anti-tab-switch logic
        let tabSwitchCount = 0;
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                tabSwitchCount++;
                socket.emit('tab_switched', { username, count: tabSwitchCount });
            }
        });

        window.addEventListener('blur', () => {
            tabSwitchCount++;
            socket.emit('tab_switched', { username, count: tabSwitchCount });
        });

        window.onload = init;
    </script>
</body>
</html>
