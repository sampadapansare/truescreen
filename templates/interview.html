<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Fraud Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- BOOTSTRAP CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script>
    let socket, pc;
    const room = "{{ meeting_id }}";

    async function init() {
      socket = io();

      // 1) join signaling room
      socket.emit('join-room', {room});

      // 2) getUserMedia
      const localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      document.getElementById('localVideo').srcObject = localStream;

      // 3) WebRTC peer connection
      pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

      pc.onicecandidate = e => {
        if(e.candidate) {
          socket.emit('signal',{room, candidate:e.candidate});
        }
      };
      pc.ontrack = e => {
        document.getElementById('remoteVideo').srcObject = e.streams[0];
      };

      // 4) signaling handlers
      socket.on('user-joined', async ()=> {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('signal',{room, offer});
      });
      socket.on('signal', async data => {
        if(data.offer) {
          await pc.setRemoteDescription(data.offer);
          const ans = await pc.createAnswer();
          await pc.setLocalDescription(ans);
          socket.emit('signal',{room, answer:ans});
        }
        if(data.answer) {
          await pc.setRemoteDescription(data.answer);
        }
        if(data.candidate) {
          await pc.addIceCandidate(data.candidate);
        }
      });

      // 5) start fraud detection loop
      setInterval(captureAndDetect, 2000);
    }

    async function captureAndDetect() {
      const video = document.getElementById('localVideo');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      canvas.toBlob(blob => {
        const form = new FormData();
        form.append('frame', blob, 'frame.jpg');
        form.append('room', room);
        fetch('/detect',{method:'POST',body:form});
      },'image/jpeg',0.7);
    }

    window.onload = () => {
      init();

      // 6) listen for fraud alerts
      socket.on('fraud-alert', data => {
        document.getElementById('alert-box').innerText = data.message;
      });
    };
  </script>
  <style>
    /* keep your existing stylesâ€¦ */
  </style>
</head>
<body>
  <div class="navbar">
    <div class="brand">Truescreen</div>
    <a href="{{ url_for('logout') }}" class="logout">Logout</a>
  </div>

  <div class="container video-page text-center">
    <h2>Meeting ID: {{ meeting_id }}</h2>
    <div id="alert-box" class="alert"></div>

    <div class="d-flex justify-content-center align-items-start">
      <!-- Local Preview -->
      <video id="localVideo" autoplay muted playsinline
             style="width:45%;border:3px solid #2f3640;border-radius:8px;"></video>
      <!-- Remote Feed -->
      <video id="remoteVideo" autoplay playsinline
             style="width:45%;border:3px solid #2f3640;border-radius:8px;margin-left:20px;"></video>
    </div>
  </div>
</body>
</html>
