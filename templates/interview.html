<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Interview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .card { background-color: white; padding: 30px; margin-top: 50px; border-radius: 10px; }
        .video-container { display: flex; gap: 20px; }
        video { border: 2px solid #2f3640; border-radius: 10px; width: 100%; height: 300px; }
        .controls { text-align: center; margin-top: 20px; }
        button { background-color: #0984e3; color: white; padding: 12px 25px; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>Live Interview - Room: {{ meeting_id }}</h2>
            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
            <div class="controls">
                <button id="startBtn">Start Call</button>
                <button id="endBtn" style="display:none;">End Call</button>
            </div>
            <div id="status">Status: Ready</div>
        </div>
    </div>

    <script>
        const socket = io();
        const room = "{{ meeting_id }}";
        let pc, localStream;

        // Enhanced ICE Servers
        const pcConfig = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" }
            ],
            iceTransportPolicy: 'all'
        };

        const startBtn = document.getElementById('startBtn');
        const endBtn = document.getElementById('endBtn');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');

        // Initialize connection
        async function init() {
            try {
                statusDiv.textContent = "Getting media...";
                
                // 1. Get local media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                localVideo.srcObject = localStream;
                
                // 2. Create peer connection
                pc = new RTCPeerConnection(pcConfig);
                
                // 3. Add local tracks
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });

                // 4. Set up event handlers
                pc.onicecandidate = e => {
                    if (e.candidate) {
                        socket.emit('ice-candidate', {
                            room: room,
                            candidate: e.candidate
                        });
                    }
                };

                pc.ontrack = e => {
                    if (!remoteVideo.srcObject) {
                        remoteVideo.srcObject = e.streams[0];
                        statusDiv.textContent = "Connected!";
                    }
                };

                pc.onconnectionstatechange = () => {
                    statusDiv.textContent = `Connection state: ${pc.connectionState}`;
                };

                // 5. Join room and start negotiation
                socket.emit('join-room', room);
                startNegotiation();

                startBtn.style.display = 'none';
                endBtn.style.display = 'inline';
                
            } catch (err) {
                console.error("Error:", err);
                statusDiv.textContent = `Error: ${err.message}`;
            }
        }

        // Start WebRTC negotiation
        async function startNegotiation() {
            try {
                statusDiv.textContent = "Starting negotiation...";
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('offer', {
                    room: room,
                    offer: pc.localDescription
                });
            } catch (err) {
                console.error("Negotiation error:", err);
            }
        }

        // Socket event handlers
        socket.on('offer', async ({ offer }) => {
            if (!pc) await init();
            
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('answer', {
                room: room,
                answer: pc.localDescription
            });
        });

        socket.on('answer', async ({ answer }) => {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on('ice-candidate', async ({ candidate }) => {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (err) {
                console.error("Error adding ICE candidate:", err);
            }
        });

        // Button handlers
        startBtn.onclick = init;
        endBtn.onclick = () => {
            if (pc) pc.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            startBtn.style.display = 'inline';
            endBtn.style.display = 'none';
            statusDiv.textContent = "Call ended";
        };

        // Auto-start (remove if you want manual start)
        window.addEventListener('load', init);
    </script>
</body>
</html>
